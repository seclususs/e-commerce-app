<section class="user-profile-section animated-element">
    <div class="profile-container">
        <div class="profile-header">
            <h2 class="section-title">Profil Saya</h2>
            <a href="{{ url_for('user.edit_profile') }}" class="cta-button-secondary" data-ajax-nav="true">
                <i class="fas fa-pen"></i> <span>Edit Profil</span>
            </a>
        </div>

        <div class="profile-info-card animated-element" data-animation-delay="200">
            <div class="profile-info-grid">
                <div class="info-item">
                    <h3>Informasi Akun</h3>
                    <p><strong>Username:</strong> {{ user.username }}</p>
                    <p><strong>Email:</strong> {{ user.email }}</p>
                </div>
                <div class="info-item">
                    <h3>Alamat Utama</h3>
                    {% if user.address_line_1 %}
                        <p><strong>Telepon:</strong> {{ user.phone }}</p>
                        <p class="address-text">
                           {{ user.address_line_1 }}<br>
                           {% if user.address_line_2 %}{{ user.address_line_2 }}<br>{% endif %}
                           {{ user.city }}, {{ user.province }} {{ user.postal_code }}
                        </p>
                    {% else %}
                        <p class="address-placeholder">Anda belum mengatur alamat utama.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="profile-tabs-container animated-element" data-animation-delay="400">
            <div class="profile-tabs">
                <button class="profile-tab-btn active" data-tab="tab-orders">
                    <i class="fas fa-receipt"></i> <span>Riwayat Pesanan</span>
                </button>
                <button class="profile-tab-btn" data-tab="tab-membership">
                    <i class="fas fa-star"></i> <span>Keanggotaan</span>
                </button>
                <button class="profile-tab-btn" data-tab="tab-vouchers">
                    <i class="fas fa-ticket-alt"></i> <span>Voucher Saya</span>
                </button>
            </div>

            <div id="tab-orders" class="profile-tab-content active">
                <div class="profile-tab-card">
                    <h3>Riwayat Pesanan</h3>
                    <div class="table-wrapper">
                        <table class="admin-table user-profile-orders">
                            <thead><tr><th>ID Pesanan</th><th>Tanggal</th><th>Total</th><th>Status</th><th>No. Resi</th><th>Aksi</th></tr></thead>
                            <tbody id="orders-list">
                                {% for order in orders %}
                                <tr id="order-row-{{ order.id }}">
                                    <td data-label="ID Pesanan:">#{{ order.id }}</td>
                                    <td data-label="Tanggal:">{{ order.order_date.strftime('%Y-%m-%d') }}</td>
                                    <td data-label="Total:">{{ order.total_amount|rupiah }}</td>
                                    <td data-label="Status:"><span class="status-badge status-{{ order.status|status_class }}">{{ order.status|status_translate }}</span></td>
                                    <td data-label="No. Resi:">{{ order.tracking_number or '-' }}</td>
                                    <td data-label="Aksi:" class="profile-order-actions">
                                        <div class="action-buttons-container">
                                            {% if order.notes and ('MEMBERSHIP_PURCHASE' in order.notes or 'MEMBERSHIP_UPGRADE' in order.notes) and order.status == 'Menunggu Pembayaran' %}
                                                <a href="{{ url_for('purchase.payment_page', order_id=order.id) }}" class="cta-button-secondary action-btn">Bayar</a>
                                            {% elif order.status != 'Menunggu Pembayaran' and not (order.notes and ('MEMBERSHIP' in order.notes)) %}
                                                <a href="{{ url_for('user.track_order', order_id=order.id) }}" class="cta-button-secondary action-btn" data-ajax-nav="true">Lacak</a>
                                            {% elif order.status == 'Menunggu Pembayaran' %}
                                                <a href="{{ url_for('purchase.payment_page', order_id=order.id) }}" class="cta-button-secondary action-btn">Bayar</a>
                                            {% endif %}
                                            
                                            {% if order.status in ['Menunggu Pembayaran', 'Diproses'] %}
                                                <button class="btn-cancel ajax-cancel-order action-btn"
                                                        data-order-id="{{ order.id }}"
                                                        data-url="{{ url_for('purchase.cancel_order', order_id=order.id) }}">
                                                    Batalkan
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="6" style="text-align: center;">Anda belum memiliki riwayat pesanan.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-membership" class="profile-tab-content">
                <div class="profile-tab-card">
                    <h3>Status Keanggotaan</h3>
                    {% if current_subscription %}
                        <div class="membership-status-container">
                            <div class="membership-badge">
                                <i class="fas fa-star"></i>
                                <h4>{{ current_subscription.name }}</h4>
                                <p class="status-active">Aktif</p>
                                <p class="expires">Berlaku hingga:<br><strong>{{ (current_subscription.end_date | datetime_from_string).strftime('%d %B %Y') }}</strong></p>
                            </div>
                            <div class="membership-details">
                                <h4>Keuntungan Anda Saat Ini:</h4>
                                <ul class="pricing-plan-features" style="text-align: left; margin: 1rem 0;">
                                    <li>
                                        <i class="fas fa-check-circle"></i>
                                        <div><strong>Diskon Member {{ current_subscription.discount_percent|float }}%</strong> untuk semua produk.</div>
                                    </li>
                                    <li>
                                        <i class="fas {% if current_subscription.free_shipping %}fa-check-circle{% else %}fa-times-circle{% endif %}"></i>
                                        {% if current_subscription.free_shipping %}
                                            <div><strong>Gratis Ongkir</strong> Tanpa Batas.</div>
                                        {% else %}
                                            <div style="opacity: 0.7;">Gratis Ongkir (Tidak Termasuk).</div>
                                        {% endif %}
                                    </li>
                                </ul>
                                <a href="{{ url_for('user.membership_page') }}" class="cta-button-secondary" style="margin-top: 1rem;" data-ajax-nav="true">
                                    Kelola Langganan
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <div class="membership-inactive-prompt">
                            <i class="fas fa-star"></i>
                            <h4>Anda Saat Ini Bukan Anggota VIP</h4>
                            <p>Upgrade keanggotaan Anda untuk menikmati diskon eksklusif dan gratis ongkir.</p>
                            <a href="{{ url_for('user.membership_page') }}" class="cta-button" style="margin-top: 1.5rem;" data-ajax-nav="true">
                                Lihat Paket VIP
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div id="tab-vouchers" class="profile-tab-content">
                {% include 'partials/user/_my_vouchers.html' %}
            </div>
        </div>

        <a href="{{ url_for('product.products_page') }}" class="cta-button-secondary" style="display:inline-block; margin-top: 2rem;" data-ajax-nav="true">Lanjutkan Belanja</a>
    </div>
</section>