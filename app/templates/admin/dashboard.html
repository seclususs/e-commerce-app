{% extends "layouts/admin_layout.html" %}

{% block admintitle %}Dashboard{% endblock %}
{% block adminheader %}Dashboard Ringkasan{% endblock %}

{% block admincontent %}
<!-- Kartu untuk tombol scheduler -->
<div class="admin-card animated-element">
    <h3>Tindakan Cepat</h3>
    <p class="form-hint">Jalankan tugas manual yang biasanya dijalankan oleh cron job di server.</p>
    <button id="run-cron-btn" data-url="{{ url_for('admin.run_scheduler') }}" class="cta-button-secondary">Jalankan Tugas Harian (Simulasi Cron)</button>
</div>

<!-- Form Filter Rentang Waktu -->
<div class="admin-card animated-element">
    <h3>Filter Tampilan</h3>
    <form method="GET" action="{{ url_for('admin.admin_dashboard') }}" id="dashboard-filter-form">
        <div class="form-grid" style="align-items: flex-end;">
            <div class="form-group">
                <label for="period">Rentang Waktu Cepat</label>
                <select name="period" id="period" class="form-control">
                    <option value="last_7_days" {% if selected_period == 'last_7_days' %}selected{% endif %}>7 Hari Terakhir</option>
                    <option value="last_30_days" {% if selected_period == 'last_30_days' %}selected{% endif %}>30 Hari Terakhir</option>
                    <option value="this_month" {% if selected_period == 'this_month' %}selected{% endif %}>Bulan Ini</option>
                    <option value="custom" {% if selected_period == 'custom' %}selected{% endif %} disabled>Rentang Kustom</option>
                </select>
            </div>
            <div class="form-group">
                <label for="custom_start">Tanggal Mulai (Kustom)</label>
                <input type="date" name="custom_start" id="custom_start" class="form-control" value="{{ custom_start or '' }}">
            </div>
            <div class="form-group">
                <label for="custom_end">Tanggal Selesai (Kustom)</label>
                <input type="date" name="custom_end" id="custom_end" class="form-control" value="{{ custom_end or '' }}">
            </div>
            <div class="form-actions" style="margin-bottom: 0;">
                <button type="submit" class="cta-button">Terapkan Kustom</button>
            </div>
        </div>
    </form>
</div>

<div class="dashboard-stats">
    <div class="stat-card animated-element" data-animation-delay="100">
        <h4>Total Penjualan</h4>
        <p>{{ stats.total_sales|rupiah }}</p>
    </div>
    <div class="stat-card animated-element" data-animation-delay="200">
        <h4>Total Pesanan</h4>
        <p>{{ stats.order_count }}</p>
    </div>
    <div class="stat-card animated-element" data-animation-delay="300">
        <h4>Pengguna Baru</h4>
        <p>{{ stats.new_user_count }}</p>
    </div>
     <div class="stat-card animated-element" data-animation-delay="400">
        <h4>Total Produk</h4>
        <p>{{ stats.product_count }}</p>
    </div>
</div>

<div class="admin-card animated-element" data-animation-delay="400">
    <h3>Grafik Penjualan Harian</h3>
    <div style="height: 350px;">
        <canvas id="salesChart" 
                data-labels='{{ chart_labels | safe }}' 
                data-data='{{ chart_data | safe }}'></canvas>
    </div>
</div>

<div class="dashboard-charts-grid">
    <div class="admin-card animated-element" data-animation-delay="500">
        <h3>Produk Terlaris</h3>
        <div style="height: 300px;">
            <canvas id="topProductsChart"
                    data-labels='{{ top_products_chart_labels | safe }}'
                    data-data='{{ top_products_chart_data | safe }}'></canvas>
        </div>
    </div>
    <div class="admin-card animated-element" data-animation-delay="600">
        <h3>Stok Segera Habis (Stok â‰¤ 5)</h3>
        <div style="height: 300px;">
             <canvas id="lowStockChart"
                     data-labels='{{ low_stock_chart_labels | safe }}'
                     data-data='{{ low_stock_chart_data | safe }}'></canvas>
        </div>
    </div>
</div>

{% endblock %}

{% block additional_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const periodSelect = document.getElementById('period');
        const customStart = document.getElementById('custom_start');
        const customEnd = document.getElementById('custom_end');
        
        periodSelect.addEventListener('change', function() {
            if (this.value !== 'custom') {
                customStart.value = '';
                customEnd.value = '';
                this.form.submit();
            }
        });
        
        document.getElementById('dashboard-filter-form').addEventListener('submit', function(e) {
            if (e.submitter && e.submitter.textContent.includes('Terapkan Kustom')) {
                 if (customStart.value && customEnd.value) {
                    let customOption = periodSelect.querySelector('option[value="custom"]');
                    if (!customOption) {
                        customOption = new Option('Rentang Kustom', 'custom');
                        periodSelect.add(customOption);
                    }
                    periodSelect.value = 'custom';
                 } else {
                     e.preventDefault();
                     alert('Harap isi tanggal mulai dan tanggal selesai untuk rentang kustom.');
                 }
            }
        });
    });
</script>
{% endblock %}